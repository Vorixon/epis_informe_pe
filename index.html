<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestor de Informes Académicos - Visión 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif;
            
            /* Paleta Inspirada en "Windows 12" (Conceptual) */
            --primary-color: #005fba;
            --primary-color-light: rgba(0, 120, 212, 0.15);
            --primary-color-focus-ring: rgba(0, 120, 212, 0.3);
            
            --success-color: #0d875a;
            --warning-color: #b48700;
            --danger-color: #d13438;
            --orange-color: #f7630c;

            --success-bg: #e7f4f0;
            --warning-bg: #fff9e6;
            --danger-bg: #fdf0f0;
            --orange-bg: #fff4ec;

            --text-primary: #0d0d0d;
            --text-secondary: #595959;
            --text-on-primary: #ffffff;
            
            --surface-ground: #f9f9f9;
            --surface-card: rgba(255, 255, 255, 0.85); /* Efecto Acrílico */
            --surface-border: rgba(0, 0, 0, 0.08);
            --surface-border-light: rgba(0, 0, 0, 0.05);
            
            --border-radius: 8px;
            --transition-speed: 0.25s;
            --box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            --box-shadow-hover: 0 8px 24px rgba(0,0,0,0.08);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--surface-ground);
            background-image: linear-gradient(to top, #f8f9fa, #ffffff);
            color: var(--text-primary);
            margin: 0;
            padding: 32px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Utilidades y Animaciones --- */
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--primary-color-light);
            border-top: 3px solid var(--primary-color); border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.65, 0.05, 0.36, 1) infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        hr { border: 0; height: 1px; background-color: var(--surface-border-light); margin: 32px 0; }

        /* --- Estructura Principal y Contenedor --- */
        #app-container { display: none; }
        .container {
            max-width: 1200px; margin: 32px auto;
            background: var(--surface-card);
            padding: 32px 40px; border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255,255,255,0.9);
        }
        h1 {
            text-align: center; color: var(--primary-color);
            font-size: 2em; font-weight: 600; margin-bottom: 8px;
        }
        #semester-display {
            text-align: center; font-size: 1.1em; font-weight: 400;
            color: var(--text-secondary); margin-bottom: 32px;
            background: var(--surface-ground); padding: 12px;
            border-radius: var(--border-radius);
        }

        /* --- Modales (Estilo Acrílico) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: none; justify-content: center; align-items: center;
            background-color: rgba(240, 240, 240, 0.5);
            backdrop-filter: blur(20px) saturate(1.5);
            -webkit-backdrop-filter: blur(20px) saturate(1.5);
        }
        .modal-content {
            background: var(--surface-card); padding: 32px; border-radius: var(--border-radius);
            width: 95%; box-shadow: var(--box-shadow-hover);
            border: 1px solid rgba(255, 255, 255, 0.9);
            position: relative;
        }
        .modal-close {
            position: absolute; top: 16px; right: 20px; font-size: 18px;
            font-weight: normal; cursor: pointer; color: var(--text-secondary);
            transition: color var(--transition-speed);
        }
        .modal-close:hover { color: var(--text-primary); }

        #semesterModal { display: flex; }
        #semesterModal .modal-content { max-width: 380px; text-align: center; }
        #semesterModal h2 { color: var(--primary-color); margin-top: 0; margin-bottom: 24px; font-weight: 600; }
        #semesterLoader { display: none; margin-top: 15px; }

        /* --- Formularios y Entradas (Estilo Fluent) --- */
        .form-section { margin-bottom: 24px; }
        .form-section label {
            font-weight: 600; display: block; margin-bottom: 8px; font-size: 0.9em;
            color: var(--text-secondary);
        }
        select, input[type="text"], input[type="number"], textarea {
            width: 100%; box-sizing: border-box; padding: 10px 12px;
            border: 1px solid var(--surface-border); border-radius: var(--border-radius);
            font-size: 1em; font-family: var(--font-family);
            background-color: #ffffff;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        select:focus, input:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color-focus-ring);
        }
        input::placeholder { color: #a1a1a1; }
        .input-error { border-color: var(--danger-color) !important; }

        /* --- Búsqueda --- */
        #search-section { display: none; }
        .search-form { display: flex; gap: 8px; }
        .search-input-wrapper { position: relative; flex-grow: 1; }
        #search-loader { display: none; align-items: center; justify-content: center; flex-direction: column; gap: 15px; padding: 40px 20px; text-align:center; }
        #search-loader h2 { font-weight: 400; color: var(--text-secondary); }
        .suggestions-container {
            display: none; position: absolute; background-color: #fff;
            border: 1px solid var(--surface-border); top: calc(100% + 4px);
            left: 0; right: 0; z-index: 1000;
            max-height: 240px; overflow-y: auto;
            box-shadow: var(--box-shadow); border-radius: var(--border-radius);
        }
        .suggestion-item { padding: 10px 15px; cursor: pointer; font-size: 1em; }
        .suggestion-item:hover { background-color: var(--primary-color-light); }

        /* --- Resultados y Tarjetas --- */
        #results-container { margin-top: 32px; }
        #teacher-details {
            background: var(--surface-ground); padding: 20px 24px; border-radius: var(--border-radius); margin-bottom: 32px;
        }
        #teacher-details h2 { color: var(--primary-color); margin: 0; font-size: 1.25em; font-weight: 600; }
        #teacher-details p { margin: 4px 0 0; color: var(--text-secondary); }
        #courses-results {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 24px;
        }
        .course-card {
            border: none; border-radius: var(--border-radius); padding: 24px;
            background-color: var(--surface-card); display: flex; flex-direction: column;
            box-shadow: var(--box-shadow);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }
        .course-card:hover { transform: translateY(-4px); box-shadow: var(--box-shadow-hover); }
        .course-card h3 { margin: 0 0 12px 0; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
        .course-card .details-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;
            padding-top: 16px; border-top: 1px solid var(--surface-border-light); font-size: 0.9em;
        }
        .course-card .detail-item strong { font-weight: 600; color: var(--text-secondary); margin-right: 6px; }

        /* --- Botones (Estilo Fluent) --- */
        .btn {
            border: 1px solid var(--surface-border); padding: 8px 16px; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; font-family: var(--font-family);
            transition: all var(--transition-speed); text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.9em; background-color: #ffffff; color: var(--text-primary);
        }
        .btn:hover:not(:disabled) { border-color: #bdbdbd; background-color: #f9f9f9; }
        .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--primary-color-focus-ring); border-color: var(--primary-color); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn.primary, #loadSemesterBtn, #searchButton, .btn-save {
            background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color);
        }
        .btn.primary:hover:not(:disabled) { background-color: #0052a2; border-color: #0052a2; }
        
        #loadSemesterBtn, #searchButton, .btn-save { font-size: 1em; padding: 10px 16px; }
        
        .course-card .card-buttons {
            display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center;
            gap: 8px; margin-top: 20px; border-top: 1px solid var(--surface-border-light); padding-top: 20px;
        }
        
        /* --- BOTONES DE ESTADO --- */
        .btn-state-new { background-color: var(--orange-bg); color: var(--orange-color); border-color: var(--orange-bg); }
        .btn-state-new:hover:not(:disabled) { background-color: #fde8d9; border-color: #fde8d9;}
        .btn-state-pending { background-color: var(--warning-bg); color: var(--warning-color); border-color: var(--warning-bg); }
        .btn-state-pending:hover:not(:disabled) { background-color: #fff6cf; border-color: #fff6cf;}
        .btn-state-completed { background-color: var(--success-bg); color: var(--success-color); border-color: var(--success-bg); }
        .btn-state-completed:hover:not(:disabled) { background-color: #e2f2ec; border-color: #e2f2ec;}
        .btn-doc-portfolio-new { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); }

        /* --- Controles de Modales --- */
        .modal-header { position: relative; }
        .modal-header h2 { font-weight: 600; font-size: 1.5em; margin-bottom: 24px; color: var(--primary-color); }
        .modal-header h2 small { font-size: 0.7em; color: var(--text-secondary); font-weight: 400; display: block; margin-top: 4px; }
        .status-indicator {
            position: absolute; top: 0; right: 0;
            padding: 4px 10px; border-radius: 12px; font-weight: 600;
            font-size: 0.8em; transition: all var(--transition-speed);
        }
        .modal-footer {
            display: flex; justify-content: flex-end; align-items: center; margin-top: 24px;
            border-top: 1px solid var(--surface-border-light); padding-top: 24px;
        }
        #final-response, #final-response-portfolio, #final-response-doc-portfolio { flex-grow: 1; text-align: left; font-weight: 500; }
        #final-response a, #final-response-portfolio a, #final-response-doc-portfolio a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        
        /* --- ESTILO DE PORCENTAJE UNIFICADO --- */
        .percent, .percentage {
            padding: 5px 8px; border-radius: var(--border-radius);
            font-weight: 600; font-size: 0.9em; text-align: center;
            background-color: var(--surface-ground); color: var(--text-secondary);
        }
        .pct-bg-green { background-color: var(--success-bg); color: var(--success-color); }
        .pct-bg-yellow { background-color: var(--warning-bg); color: var(--warning-color); }
        .pct-bg-red { background-color: var(--danger-bg); color: var(--danger-color); }

        /* --- Modal de Prueba de Entrada --- */
        #reportModal .modal-content { max-width: 1024px; max-height: 90vh; overflow-y: auto; }
        .skills-header, .skill-row {
            display: grid; grid-template-columns: 2.5fr 1fr 0.8fr 1fr 0.8fr 1fr 0.8fr 1fr 40px;
            gap: 12px; align-items: center;
        }
        .skills-header {
            font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid var(--surface-border);
            font-size: 0.8em; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .skill-row { margin-top: 12px; }
        .btn-remove-skill { background-color: transparent; color: var(--text-secondary); padding: 4px; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; border: none; }
        .btn-remove-skill:hover { background-color: var(--danger-bg); color: var(--danger-color); }
        #validation-message { color: var(--danger-color); font-weight: 500; margin-top: 12px; text-align: center; height: 20px; font-size: 0.9em; }
        .corrective-measures h4, .signature-section h4 { color: var(--text-primary); font-weight: 600; margin-bottom: 16px; font-size: 1.1em; }
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group label { font-size: 0.95em; }
        
        /* --- Firma --- */
        .signature-pad-wrapper { border: 2px dashed var(--surface-border); border-radius: var(--border-radius); position: relative; height: 180px; background: #fff; }
        canvas { width: 100%; height: 100%; cursor: crosshair; touch-action: none; }
        .existing-signature-wrapper iframe { width: 100%; height: 180px; border: 1px solid var(--surface-border); border-radius: var(--border-radius); }
        
        /* --- Modal Portafolio --- */
        #portfolioModal .modal-content { max-width: 1024px; max-height: 90vh; overflow-y: auto; }
        .portfolio-grid { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr; gap: 12px; align-items: center; }
        .portfolio-grid .grid-header { font-weight: 600; color: var(--text-secondary); padding: 8px 0; border-bottom: 1px solid var(--surface-border); font-size: 0.8em; text-transform: uppercase; }
        .portfolio-grid label { font-weight: 600; }
        input:read-only { background-color: var(--surface-border-light); font-weight: 600; border-color: transparent; }
        .portfolio-grid .percentage { position: relative; overflow: hidden; height: 38px; display: flex; justify-content: center; align-items: center; }
        .portfolio-grid .sub-group { padding-left: 20px; border-left: 2px solid var(--surface-border-light); }
        #portfolioValidationMsg { color: var(--danger-color); font-weight: 500; margin-top: 16px; text-align: center; height: 20px; font-size: 0.9em; }
        
        .material-grid {
            display: grid; grid-template-columns: 2fr 0.5fr 0.5fr 1fr 1.5fr; gap: 12px; align-items: center; margin-top: 20px;
        }
        .material-grid .grid-header { font-weight: 600; text-align: center; color: var(--text-secondary); font-size: 0.8em; text-transform: uppercase; }
        .material-grid label { font-size: 0.95em; }
        .material-grid input[type="checkbox"] { justify-self: center; width: 18px; height: 18px; }

        /* --- Modal Documentación --- */
        #docPortfolioModal .modal-content { max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .doc-category { font-weight: 600; color: var(--primary-color); margin-top: 24px; padding-bottom: 8px; font-size: 1.1em; }
        .doc-subcategory { font-weight: 600; color: var(--text-primary); margin-top: 16px; margin-left: 15px; font-size: 1em; }
        .doc-item { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center; padding: 8px 0 8px 30px; border-bottom: 1px solid var(--surface-border-light); }
        .doc-item label { font-size: 0.95em; color: var(--text-secondary); }
        .project-block { background: var(--surface-ground); border-radius: var(--border-radius); padding: 16px; margin-top: 10px; border: 1px solid var(--surface-border); }
        .project-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--surface-border); }
        .project-item { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; align-items: center; margin-top: 10px; }
        .file-upload-wrapper { display: flex; align-items: center; gap: 8px; }
        input[type="file"] { display: none; }
        .file-btn { padding: 6px 12px; font-size: 0.85em; flex-shrink: 0; }
        .file-name { font-size: 0.8em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-height: 1.2em; padding: 4px 8px; border-radius: var(--border-radius); }
        .file-name a { color: var(--primary-color); text-decoration: none; font-weight: 600;}
        .file-name-filled { background-color: var(--success-bg); color: var(--success-color); font-weight: 600; }

        @media (max-width: 768px) {
            body { padding: 12px; }
            .container, .modal-content { padding: 16px; }
            .skills-header, .skill-row { font-size: 0.7em; gap: 5px; grid-template-columns: 2fr repeat(7, 1fr) 30px; }
            .checkbox-grid { grid-template-columns: 1fr; }
            .material-grid { grid-template-columns: 1fr; text-align: left; gap: 16px; }
            .material-grid .grid-header { display: none; }
            .doc-item, .project-item { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- MODAL DE SELECCIÓN DE SEMESTRE -->
    <div id="semesterModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Seleccione el Semestre</h2>
            <select id="semesterSelector">
                <option value="2025-1">2025-1</option><option value="2025-2">2025-2</option>
                <option value="2024-2">2024-2</option><option value="2024-1">2024-1</option>
            </select>
            <button id="loadSemesterBtn" class="btn primary" style="width: 100%; margin-top: 16px;">Cargar Datos</button>
            <div id="semesterLoader"><div class="spinner" style="margin: 20px auto 0;"></div></div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL DE LA APLICACIÓN -->
    <div id="app-container">
        <div class="container">
            <h1>Gestor de Informes Académicos</h1>
            <div id="semester-display"></div>
            
            <div class="form-section">
                <label for="reportTypeSelector">1. Seleccione el tipo de informe</label>
                <select id="reportTypeSelector">
                    <option value="" disabled selected>-- Elija una opción --</option>
                    <option value="entryTest">Informe de Prueba de Entrada</option>
                    <option value="portfolio_I">Portafolio por Unidad I</option>
                    <option value="portfolio_II">Portafolio por Unidad II</option>
                    <option value="portfolio_III">Portafolio por Unidad III</option>
                    <option value="docPortfolio">Documentación de Portafolio de Curso</option>
                </select>
            </div>

            <div id="search-section" class="form-section">
                <label for="teacherInput">2. Busque su nombre</label>
                <div class="search-container">
                    <div class="search-form">
                        <div class="search-input-wrapper">
                            <input type="text" id="teacherInput" placeholder="Escribe el nombre del docente..." autocomplete="off" required>
                            <div id="suggestions" class="suggestions-container"></div>
                        </div>
                        <button type="button" id="searchButton" class="btn primary">Buscar</button>
                    </div>
                </div>
            </div>

            <div id="search-loader"></div>
            <div id="results-container">
                <div id="teacher-details"></div>
                <div id="courses-results"></div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA PRUEBA DE ENTRADA -->
    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <div id="entryTestStatusIndicator" class="status-indicator"></div>
            </div>
            <div class="modal-body">
                 <div class="top-form-group" style="display: flex; gap: 24px; align-items: center; margin-bottom: 24px;">
                    <div>
                        <label>Matriculados:</label><input type="number" id="matriculados" min="0" style="width: 120px;">
                    </div>
                    <div>
                        <label>Evaluados:</label><input type="number" id="evaluados" min="0" style="width: 120px;">
                    </div>
                </div>
                <div class="skills-header">
                    <div>Conocimiento</div><div>Deficiente</div><div>%</div>
                    <div>Suficiente</div><div>%</div><div>Bueno</div>
                    <div>%</div><div>Total %</div><div></div>
                </div>
                <div id="skills-container"></div>
                <div class="add-skill-container" style="text-align: right; margin-top: 16px;">
                    <button id="addSkillBtn" class="btn primary">Agregar Conocimiento</button>
                </div>
                <div id="validation-message"></div>
                <hr>
                <div class="corrective-measures">
                    <h4>Medidas correctivas tomadas</h4>
                    <div class="checkbox-grid">
                        <div class="checkbox-group"><input type="checkbox" id="repaso_clase"><label for="repaso_clase">1. Repaso en horas de clase</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="entrega_material"><label for="entrega_material">4. Entrega de material de repaso</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="repaso_adicional"><label for="repaso_adicional">2. Repaso con horas adicionales</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="recomendacion_biblio"><label for="recomendacion_biblio">5. Recomendación de bibliografía</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="ejercicios_casa"><label for="ejercicios_casa">3. Ejercicios para resolver en casa</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="otros_check"><label for="otros_check">6. Otros (Detalle en descripción)</label></div>
                    </div>
                    <div class="description-group" style="margin-top: 20px;">
                        <label for="otros_descripcion">Describa otras medidas y/o recomendaciones:</label>
                        <textarea id="otros_descripcion"></textarea>
                    </div>
                    <div class="date-group" style="margin-top: 20px;">
                        <label for="fecha_informe">Fecha del Informe:</label>
                        <input type="date" id="fecha_informe" style="width: auto;">
                    </div>
                </div>
                <hr>
                <div class="signature-section">
                    <h4>Firma del Docente</h4>
                    <div id="signature_pad_wrapper" class="signature-pad-wrapper">
                        <canvas id="signature_canvas"></canvas>
                    </div>
                    <div id="existing_signature_wrapper" class="existing-signature-wrapper" style="display: none;">
                        <p><strong>Firma guardada:</strong></p>
                        <iframe id="existing_signature_iframe" src="" allow="autoplay"></iframe>
                    </div>
                    <div class="signature-controls" style="margin-top: 10px; display: flex; justify-content: flex-end;">
                        <button id="clear_signature_btn" class="btn">Limpiar Firma</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="final-response"></div>
                <button id="saveReportBtn" class="btn primary btn-save">Guardar Informe</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA PORTAFOLIO -->
    <div id="portfolioModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <div class="modal-header">
                <h2 id="portfolioModalTitle"></h2>
                <div id="portfolioStatusIndicator" class="status-indicator"></div>
            </div>
            <div class="modal-body">
                <div id="portfolio-form-container">
                    <div class="portfolio-grid">
                        <div class="grid-header">Estudiantes</div>
                        <div class="grid-header">Cantidad</div>
                        <div class="grid-header">Porcentaje</div>
                        <div class="grid-row" style="grid-column: 1 / -1; display: contents;">
                            <label for="p_matriculados">Matriculados</label>
                            <input type="number" id="p_matriculados" min="0">
                            <div class="percentage pct-bg-green"><span id="p_matriculados_span"></span></div>
                        </div>
                        <div class="grid-row sub-group" style="grid-column: 1 / -1; display: contents;">
                            <label>Retirados</label>
                            <input type="number" id="p_retirados" min="0">
                            <div class="percentage" style="background: transparent;"><span id="p_retirados_span"></span></div>
                        </div>
                        <div class="grid-row sub-group" style="grid-column: 1 / -1; display: contents;">
                            <label>Abandono</label>
                            <input type="number" id="p_abandono" min="0">
                            <div class="percentage" style="background: transparent;"><span id="p_abandono_span"></span></div>
                        </div>
                        <div class="grid-row" style="grid-column: 1 / -1; display: contents;">
                            <label>Asisten</label>
                            <input type="number" id="p_asisten" readonly>
                            <div class="percentage"><span id="p_asisten_span"></span></div>
                        </div>
                        <div class="grid-row sub-group" style="grid-column: 1 / -1; display: contents;">
                             <label>Aprobados</label>
                            <input type="number" id="p_aprobados" min="0">
                            <div class="percentage" style="background: transparent;"><span id="p_aprobados_span"></span></div>
                        </div>
                        <div class="grid-row sub-group" style="grid-column: 1 / -1; display: contents;">
                            <label>Desaprobados</label>
                            <input type="number" id="p_desaprobados" readonly>
                            <div class="percentage" style="background: transparent;"><span id="p_desaprobados_span"></span></div>
                        </div>
                    </div>
                    <div id="portfolioValidationMsg"></div>
                    <hr>
                    <h4>I. Material que el docente prepara y entrega</h4>
                    <div id="material-docente-container" class="material-grid">
                        <div class="grid-header">Material Docente</div>
                        <div class="grid-header">Dig</div><div class="grid-header">Imp</div>
                        <div class="grid-header">Cant</div><div class="grid-header">Evidencia</div>
                        
                        <label>Sílabo formato UPT</label>
                        <input type="checkbox" id="dig_silabo_upt"><input type="checkbox" id="imp_silabo_upt">
                        <input type="number" id="cant_silabo_upt" min="0">
                        <div class="file-upload-wrapper"><label for="file_silabo_upt" class="btn file-btn">Adjuntar</label><input type="file" id="file_silabo_upt"><span class="file-name" id="fname_silabo_upt"></span></div>
                        
                        <label>Sílabo formato ICACIT</label>
                        <input type="checkbox" id="dig_silabo_icacit"><input type="checkbox" id="imp_silabo_icacit">
                        <input type="number" id="cant_silabo_icacit" min="0">
                        <div class="file-upload-wrapper"><label for="file_silabo_icacit" class="btn file-btn">Adjuntar</label><input type="file" id="file_silabo_icacit"><span class="file-name" id="fname_silabo_icacit"></span></div>

                        <label>Curriculum Vitae formato ICACIT</label>
                        <input type="checkbox" id="dig_cv_icacit"><input type="checkbox" id="imp_cv_icacit">
                        <input type="number" id="cant_cv_icacit" min="0">
                        <div class="file-upload-wrapper"><label for="file_cv_icacit" class="btn file-btn">Adjuntar</label><input type="file" id="file_cv_icacit"><span class="file-name" id="fname_cv_icacit"></span></div>

                        <label>Material del Curso (Texto, Diapositivas)</label>
                        <input type="checkbox" id="dig_material_curso"><input type="checkbox" id="imp_material_curso">
                        <input type="number" id="cant_material_curso" min="0">
                        <div class="file-upload-wrapper"><label for="file_material_curso" class="btn file-btn">Adjuntar</label><input type="file" id="file_material_curso"><span class="file-name" id="fname_material_curso"></span></div>

                        <label>Guías de laboratorio y talleres</label>
                        <input type="checkbox" id="dig_guias_lab"><input type="checkbox" id="imp_guias_lab">
                        <input type="number" id="cant_guias_lab" min="0">
                        <div class="file-upload-wrapper"><label for="file_guias_lab" class="btn file-btn">Adjuntar</label><input type="file" id="file_guias_lab"><span class="file-name" id="fname_guias_lab"></span></div>

                        <label>Enunciado y resolución de exámenes</label>
                        <input type="checkbox" id="dig_examenes"><input type="checkbox" id="imp_examenes">
                        <input type="number" id="cant_examenes" min="0">
                        <div class="file-upload-wrapper"><label for="file_examenes" class="btn file-btn">Adjuntar</label><input type="file" id="file_examenes"><span class="file-name" id="fname_examenes"></span></div>

                        <label>Enunciado de las practicas o casos practicos</label>
                        <input type="checkbox" id="dig_practicas"><input type="checkbox" id="imp_practicas">
                        <input type="number" id="cant_practicas" min="0">
                        <div class="file-upload-wrapper"><label for="file_practicas" class="btn file-btn">Adjuntar</label><input type="file" id="file_practicas"><span class="file-name" id="fname_practicas"></span></div>
                        
                        <label>Registro de Asistencia</label>
                        <input type="checkbox" id="dig_asistencia"><input type="checkbox" id="imp_asistencia">
                        <input type="number" id="cant_asistencia" min="0">
                        <div class="file-upload-wrapper"><label for="file_asistencia" class="btn file-btn">Adjuntar</label><input type="file" id="file_asistencia"><span class="file-name" id="fname_asistencia"></span></div>
                        
                        <label>Registro de Notas</label>
                        <input type="checkbox" id="dig_notas"><input type="checkbox" id="imp_notas">
                        <input type="number" id="cant_notas" min="0">
                        <div class="file-upload-wrapper"><label for="file_notas" class="btn file-btn">Adjuntar</label><input type="file" id="file_notas"><span class="file-name" id="fname_notas"></span></div>

                        <label>Fichas de evaluaciones (Rúbricas)</label>
                        <input type="checkbox" id="dig_evaluaciones"><input type="checkbox" id="imp_evaluaciones">
                        <input type="number" id="cant_evaluaciones" min="0">
                        <div class="file-upload-wrapper"><label for="file_evaluaciones" class="btn file-btn">Adjuntar</label><input type="file" id="file_evaluaciones"><span class="file-name" id="fname_evaluaciones"></span></div>
                    </div>
                    <hr>
                    <h4>II. Material generado por el estudiante</h4>
                     <div id="material-estudiante-container" class="material-grid">
                        <div class="grid-header">Material Estudiante</div>
                        <div class="grid-header">Dig</div><div class="grid-header">Imp</div>
                        <div class="grid-header">Cant</div><div class="grid-header">Evidencia</div>

                        <label>Copias de cuadernos o apuntes</label>
                        <input type="checkbox" id="dig_est_cuadernos"><input type="checkbox" id="imp_est_cuadernos">
                        <input type="number" id="cant_est_cuadernos" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_cuadernos" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_cuadernos"><span class="file-name" id="fname_est_cuadernos"></span></div>

                        <label>Original de exámenes de unidad</label>
                        <input type="checkbox" id="dig_est_examenes"><input type="checkbox" id="imp_est_examenes">
                        <input type="number" id="cant_est_examenes" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_examenes" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_examenes"><span class="file-name" id="fname_est_examenes"></span></div>

                        <label>Original de evaluaciones practicas</label>
                        <input type="checkbox" id="dig_est_eval_practicas"><input type="checkbox" id="imp_est_eval_practicas">
                        <input type="number" id="cant_est_eval_practicas" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_eval_practicas" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_eval_practicas"><span class="file-name" id="fname_est_eval_practicas"></span></div>

                        <label>Original de informes de laboratorios</label>
                        <input type="checkbox" id="dig_est_inf_lab"><input type="checkbox" id="imp_est_inf_lab">
                        <input type="number" id="cant_est_inf_lab" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_inf_lab" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_inf_lab"><span class="file-name" id="fname_est_inf_lab"></span></div>

                        <label>Trabajos encargado (investigación, etc.)</label>
                        <input type="checkbox" id="dig_est_trabajos"><input type="checkbox" id="imp_est_trabajos">
                        <input type="number" id="cant_est_trabajos" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_trabajos" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_trabajos"><span class="file-name" id="fname_est_trabajos"></span></div>

                        <label>Trabajos y/o proyectos finales</label>
                        <input type="checkbox" id="dig_est_proyectos"><input type="checkbox" id="imp_est_proyectos">
                        <input type="number" id="cant_est_proyectos" min="0">
                        <div class="file-upload-wrapper"><label for="file_est_proyectos" class="btn file-btn">Adjuntar</label><input type="file" id="file_est_proyectos"><span class="file-name" id="fname_est_proyectos"></span></div>
                    </div>
                    <hr>
                    <div class="date-group" style="margin-top: 20px;">
                        <label for="fecha_entrega_portfolio">Fecha de Entrega:</label>
                        <input type="date" id="fecha_entrega_portfolio" style="width: auto;">
                    </div>
                    <div class="signature-section" style="margin-top: 24px;">
                        <h4>Firma del Docente</h4>
                        <div id="signature_pad_wrapper_portfolio" class="signature-pad-wrapper">
                            <canvas id="signature_canvas_portfolio"></canvas>
                        </div>
                        <div id="existing_signature_wrapper_portfolio" class="existing-signature-wrapper" style="display: none;">
                            <p><strong>Firma guardada:</strong></p>
                            <iframe id="existing_signature_iframe_portfolio" src="" allow="autoplay"></iframe>
                        </div>
                        <div class="signature-controls" style="margin-top: 10px; display: flex; justify-content: flex-end;">
                            <button id="clear_signature_btn_portfolio" class="btn">Limpiar Firma</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="final-response-portfolio"></div>
                <button id="savePortfolioBtn" class="btn primary btn-save">Guardar Datos</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA DOCUMENTACIÓN DE PORTAFOLIO -->
    <div id="docPortfolioModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <div class="modal-header"><h2 id="docPortfolioModalTitle"></h2></div>
            <div class="modal-body">
                <div id="doc-portfolio-form-container">
                    <!-- Las filas se generarán dinámicamente con JavaScript -->
                </div>
                 <hr>
                <div class="signature-section">
                    <h4>Firma del Docente</h4>
                    <div id="signature_pad_wrapper_doc" class="signature-pad-wrapper">
                        <canvas id="signature_canvas_doc"></canvas>
                    </div>
                    <div id="existing_signature_wrapper_doc" class="existing-signature-wrapper" style="display: none;">
                        <p><strong>Firma guardada:</strong></p>
                        <iframe id="existing_signature_iframe_doc" src="" allow="autoplay"></iframe>
                    </div>
                    <div class="signature-controls" style="margin-top: 10px; display: flex; justify-content: flex-end;">
                        <button id="clear_signature_btn_doc" class="btn">Limpiar Firma</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="final-response-doc-portfolio"></div>
                <button id="saveDocPortfolioBtn" class="btn primary btn-save">Guardar Documentación</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxcIpjkcdAOeFJWH7IJPVL59_yEhIdkNbGm94jZ8_xCQxgDOkuJyBDxIijsLUhhMlEr/exec";
        
        const semesterModal = document.getElementById('semesterModal');
        const semesterSelector = document.getElementById('semesterSelector');
        const loadSemesterBtn = document.getElementById('loadSemesterBtn');
        const semesterLoader = document.getElementById('semesterLoader');
        const appContainer = document.getElementById('app-container');
        const semesterDisplay = document.getElementById('semester-display');
        const reportTypeSelector = document.getElementById('reportTypeSelector');
        const searchSection = document.getElementById('search-section');
        const teacherInput = document.getElementById('teacherInput');
        const searchButton = document.getElementById('searchButton');
        const suggestionsDiv = document.getElementById('suggestions');
        const searchLoader = document.getElementById('search-loader');
        const teacherDetailsDiv = document.getElementById('teacher-details');
        const coursesResultsDiv = document.getElementById('courses-results');
        
        const reportModal = document.getElementById('reportModal');
        const modalTitle = document.getElementById('modalTitle');
        const entryTestStatusIndicator = document.getElementById('entryTestStatusIndicator');
        const matriculadosInput = document.getElementById('matriculados');
        const evaluadosInput = document.getElementById('evaluados');
        const skillsContainer = document.getElementById('skills-container');
        const addSkillBtn = document.getElementById('addSkillBtn');
        const validationMsg = document.getElementById('validation-message');
        const chkRepasoClase = document.getElementById('repaso_clase');
        const chkRepasoAdicional = document.getElementById('repaso_adicional');
        const chkEjerciciosCasa = document.getElementById('ejercicios_casa');
        const chkEntregaMaterial = document.getElementById('entrega_material');
        const chkRecomendacionBiblio = document.getElementById('recomendacion_biblio');
        const chkOtros = document.getElementById('otros_check');
        const txtOtrosDescripcion = document.getElementById('otros_descripcion');
        const inputFecha = document.getElementById('fecha_informe');
        const signaturePadWrapper = document.getElementById('signature_pad_wrapper');
        const signatureCanvas = document.getElementById('signature_canvas');
        const clearSignatureBtn = document.getElementById('clear_signature_btn');
        const existingSignatureWrapper = document.getElementById('existing_signature_wrapper');
        const existingSignatureIframe = document.getElementById('existing_signature_iframe');
        const saveReportBtn = document.getElementById('saveReportBtn');
        const finalResponseDiv = document.getElementById('final-response');

        const portfolioModal = document.getElementById('portfolioModal');
        const portfolioFormContainer = document.getElementById('portfolio-form-container');
        const portfolioModalTitle = document.getElementById('portfolioModalTitle');
        const portfolioStatusIndicator = document.getElementById('portfolioStatusIndicator');
        const savePortfolioBtn = document.getElementById('savePortfolioBtn');
        const p_matriculados = document.getElementById('p_matriculados');
        const p_retirados = document.getElementById('p_retirados');
        const p_abandono = document.getElementById('p_abandono');
        const p_asisten = document.getElementById('p_asisten');
        const p_aprobados = document.getElementById('p_aprobados');
        const p_desaprobados = document.getElementById('p_desaprobados');
        const portfolioValidationMsg = document.getElementById('portfolioValidationMsg');
        const finalResponsePortfolioDiv = document.getElementById('final-response-portfolio');
        const inputFechaPortfolio = document.getElementById('fecha_entrega_portfolio');
        const signaturePadWrapperPortfolio = document.getElementById('signature_pad_wrapper_portfolio');
        const signatureCanvasPortfolio = document.getElementById('signature_canvas_portfolio');
        const clearSignatureBtnPortfolio = document.getElementById('clear_signature_btn_portfolio');
        const existingSignatureWrapperPortfolio = document.getElementById('existing_signature_wrapper_portfolio');
        const existingSignatureIframePortfolio = document.getElementById('existing_signature_iframe_portfolio');

        const docPortfolioModal = document.getElementById('docPortfolioModal');
        const docPortfolioFormContainer = document.getElementById('doc-portfolio-form-container');
        const docPortfolioModalTitle = document.getElementById('docPortfolioModalTitle');
        const saveDocPortfolioBtn = document.getElementById('saveDocPortfolioBtn');
        const finalResponseDocPortfolioDiv = document.getElementById('final-response-doc-portfolio');
        const signaturePadWrapperDoc = document.getElementById('signature_pad_wrapper_doc');
        const signatureCanvasDoc = document.getElementById('signature_canvas_doc');
        const clearSignatureBtnDoc = document.getElementById('clear_signature_btn_doc');
        const existingSignatureWrapperDoc = document.getElementById('existing_signature_wrapper_doc');
        const existingSignatureIframeDoc = document.getElementById('existing_signature_iframe_doc');

        let allTeachers = [];
        let currentCourseData = {};
        let currentTeacherData = {};
        let selectedSemester = '';
        let selectedReportType = '';
        let existingEntryReports = {};
        let existingPortfolioReports = {};
        let existingDocPortfolioReports = {};
        let currentReportId = null;
        let entrySignaturePad;
        let portfolioSignaturePad;
        let docPortfolioSignaturePad;
        let refreshOnClose = false;
        
        const materialKeys = [
            'silabo_upt', 'silabo_icacit', 'cv_icacit', 'material_curso', 'guias_lab', 'examenes', 'practicas', 'asistencia', 'notas', 'evaluaciones',
            'est_cuadernos', 'est_examenes', 'est_eval_practicas', 'est_inf_lab', 'est_trabajos', 'est_proyectos'
        ];

        const docPortfolioStructure = [
            { type: 'category', label: '1. Información General' },
            { type: 'item', key: 'url_cv_personal', label: 'Curriculum Personal' },
            { type: 'item', key: 'url_cv_icacit', label: 'Curriculum ICACIT' },
            { type: 'category', label: '2. Prueba de Entrada' },
            { type: 'item', key: 'url_examen_entrada', label: 'Examen' },
            { type: 'item', key: 'url_notas_entrada', label: 'Notas' },
            { type: 'category', label: '3. Sílabos' },
            { type: 'item', key: 'url_silabo_upt', label: 'Silabo UPT' },
            { type: 'item', key: 'url_silabo_icacit', label: 'Silabo ICACIT' },
            { type: 'category', label: '4. Unidad I' },
            { type: 'subcategory', label: '4.1. Notas Asistencia' },
            { type: 'item', key: 'url_notas_u1', label: 'Notas (U1)' },
            { type: 'subcategory', label: '4.2. Recursos Docente' },
            { type: 'item', key: 'url_solucion_examen_u1', label: 'Solución Examen (U1)' },
            { type: 'item', key: 'url_presentaciones_u1', label: 'Presentaciones (Diapositivas) (U1)' },
            { type: 'item', key: 'url_guias_lab_u1', label: 'Guías de Laboratorios (U1)' },
            { type: 'item', key: 'url_otros_recursos_docente_u1', label: 'Otros Recursos (U1)' },
            { type: 'subcategory', label: '4.3. Recursos Estudiante' },
            { type: 'item', key: 'url_examenes_estudiante_u1', label: 'Examenes (U1)' },
            { type: 'item', key: 'url_practicas_calificadas_u1', label: 'Practicas Calificadas (U1)' },
            { type: 'item', key: 'url_proyecto_final_u1', label: 'Proyecto Final (U1)' },
            { type: 'item', key: 'url_otros_recursos_estudiante_u1', label: 'Otros Recursos (U1)' },
            { type: 'category', label: '5. Unidad II' },
            { type: 'subcategory', label: '4.1. Notas Asistencia' },
            { type: 'item', key: 'url_notas_u2', label: 'Notas (U2)' },
            { type: 'subcategory', label: '4.2. Recursos Docente' },
            { type: 'item', key: 'url_solucion_examen_u2', label: 'Solución Examen (U2)' },
            { type: 'item', key: 'url_presentaciones_u2', label: 'Presentaciones (Diapositivas) (U2)' },
            { type: 'item', key: 'url_guias_lab_u2', label: 'Guías de Laboratorios (U2)' },
            { type: 'item', key: 'url_otros_recursos_docente_u2', label: 'Otros Recursos (U2)' },
            { type: 'subcategory', label: '4.3. Recursos Estudiante' },
            { type: 'item', key: 'url_examenes_estudiante_u2', label: 'Examenes (U2)' },
            { type: 'item', key: 'url_practicas_calificadas_u2', label: 'Practicas Calificadas (U2)' },
            { type: 'item', key: 'url_proyecto_final_u2', label: 'Proyecto Final (U2)' },
            { type: 'item', key: 'url_otros_recursos_estudiante_u2', label: 'Otros Recursos (U2)' },
            { type: 'category', label: '6. Unidad III' },
            { type: 'subcategory', label: '4.1. Notas Asistencia' },
            { type: 'item', key: 'url_notas_u3', label: 'Notas (U3)' },
            { type: 'subcategory', label: '4.2. Recursos Docente' },
            { type: 'item', key: 'url_solucion_examen_u3', label: 'Solución Examen (U3)' },
            { type: 'item', key: 'url_presentaciones_u3', label: 'Presentaciones (Diapositivas) (U3)' },
            { type: 'item', key: 'url_guias_lab_u3', label: 'Guías de Laboratorios (U3)' },
            { type: 'item', key: 'url_otros_recursos_docente_u3', label: 'Otros Recursos (U3)' },
            { type: 'subcategory', label: '4.3. Recursos Estudiante' },
            { type: 'item', key: 'url_examenes_estudiante_u3', label: 'Examenes (U3)' },
            { type: 'item', key: 'url_practicas_calificadas_u3', label: 'Practicas Calificadas (U3)' },
            { type: 'item', key: 'url_otros_recursos_estudiante_u3', label: 'Otros Recursos' },
            { type: 'project_section', label: '4.3.1. Proyecto Final (U3)'}
        ];
        
        function resizeCanvas(canvas, pad) {
            if (!pad) return;
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            pad.clear();
        }

        window.addEventListener('resize', () => {
            resizeCanvas(signatureCanvas, entrySignaturePad);
            resizeCanvas(signatureCanvasPortfolio, portfolioSignaturePad);
            resizeCanvas(signatureCanvasDoc, docPortfolioSignaturePad);
        }); 

        clearSignatureBtn.addEventListener('click', () => {
             if (signaturePadWrapper.style.display !== 'none' && entrySignaturePad) {
                entrySignaturePad.clear();
             } else {
                existingSignatureWrapper.style.display = 'none';
                signaturePadWrapper.style.display = 'block';
                clearSignatureBtn.textContent = 'Limpiar Firma';
                setTimeout(() => {
                    entrySignaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)' });
                    resizeCanvas(signatureCanvas, entrySignaturePad);
                }, 50);
             }
        });

        clearSignatureBtnPortfolio.addEventListener('click', () => {
             if (signaturePadWrapperPortfolio.style.display !== 'none' && portfolioSignaturePad) {
                portfolioSignaturePad.clear();
             } else {
                existingSignatureWrapperPortfolio.style.display = 'none';
                signaturePadWrapperPortfolio.style.display = 'block';
                clearSignatureBtnPortfolio.textContent = 'Limpiar Firma';
                setTimeout(() => {
                    portfolioSignaturePad = new SignaturePad(signatureCanvasPortfolio, { backgroundColor: 'rgb(255, 255, 255)' });
                    resizeCanvas(signatureCanvasPortfolio, portfolioSignaturePad);
                }, 50);
             }
        });
        
        clearSignatureBtnDoc.addEventListener('click', () => {
             if (signaturePadWrapperDoc.style.display !== 'none' && docPortfolioSignaturePad) {
                docPortfolioSignaturePad.clear();
             } else {
                existingSignatureWrapperDoc.style.display = 'none';
                signaturePadWrapperDoc.style.display = 'block';
                clearSignatureBtnDoc.textContent = 'Limpiar Firma';
                setTimeout(() => {
                    docPortfolioSignaturePad = new SignaturePad(signatureCanvasDoc, { backgroundColor: 'rgb(255, 255, 255)' });
                    resizeCanvas(signatureCanvasDoc, docPortfolioSignaturePad);
                }, 50);
             }
        });

        loadSemesterBtn.addEventListener('click', async () => {
            selectedSemester = semesterSelector.value;
            semesterLoader.style.display = 'block';
            loadSemesterBtn.disabled = true;
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getInitialData&semestre=${selectedSemester}`);
                if (!response.ok) throw new Error(`Error en la red: ${response.statusText}`);
                const result = await response.json();
                if (result.success) {
                    allTeachers = result.data.teachers;
                    semesterDisplay.textContent = `Semestre de Trabajo: ${selectedSemester}`;
                    semesterModal.style.display = 'none';
                    appContainer.style.display = 'block';
                } else { throw new Error(result.message); }
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Error al Cargar', text: error.message });
                semesterLoader.style.display = 'none';
                loadSemesterBtn.disabled = false;
            }
        });

        reportTypeSelector.addEventListener('change', () => {
            selectedReportType = reportTypeSelector.value;
            searchSection.style.display = 'block';
            teacherInput.value = '';
            teacherDetailsDiv.innerHTML = '';
            coursesResultsDiv.innerHTML = '';
            suggestionsDiv.style.display = 'none';
        });

        teacherInput.addEventListener('input', () => {
            teacherDetailsDiv.innerHTML = ''; 
            coursesResultsDiv.innerHTML = '';
            const inputText = teacherInput.value.toLowerCase();
            if (inputText.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            const filteredTeachers = allTeachers.filter(teacher => teacher.toLowerCase().includes(inputText));
            displaySuggestions(filteredTeachers);
        });
        
        function displaySuggestions(teachers) {
            suggestionsDiv.innerHTML = '';
            if (teachers.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            teachers.forEach(teacher => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = teacher;
                item.addEventListener('click', () => { 
                    teacherInput.value = teacher; 
                    suggestionsDiv.style.display = 'none'; 
                    performSearch(teacher); 
                });
                suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.style.display = 'block';
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-wrapper')) {
                suggestionsDiv.style.display = 'none';
            }
        });

        searchButton.addEventListener('click', () => { 
            if(teacherInput.value) {
                suggestionsDiv.style.display = 'none';
                performSearch(teacherInput.value);
            }
        });
        teacherInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && teacherInput.value) {
                suggestionsDiv.style.display = 'none';
                performSearch(teacherInput.value);
            }
        });

        async function performSearch(teacherName) {
            searchLoader.style.display = 'flex';
            searchLoader.innerHTML = `<div class="spinner"></div><h2>Buscando datos del docente...</h2>`;
            teacherDetailsDiv.innerHTML = ''; 
            coursesResultsDiv.innerHTML = '';
            try {
                const url = `${WEB_APP_URL}?action=searchByTeacher&teacher=${encodeURIComponent(teacherName)}&semestre=${selectedSemester}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error en la red: ${response.statusText}`);
                const result = await response.json();
                searchLoader.style.display = 'none';
                if (result.success) {
                    currentTeacherData = result.data.details;
                    existingEntryReports = result.data.existingEntryReports;
                    existingPortfolioReports = result.data.existingPortfolioReports;
                    existingDocPortfolioReports = result.data.existingDocPortfolioReports;
                    displayTeacherDetails(result.data.details);
                    displayCourses(result.data.courses, teacherName);
                } else { throw new Error(result.message); }
            } catch (error) { 
                searchLoader.style.display = 'none'; 
                coursesResultsDiv.innerHTML = `<p class="message" style="color:var(--danger-color);font-weight:bold;">${error.message}</p>`; 
            }
        }

        function displayTeacherDetails(details) { 
            teacherDetailsDiv.innerHTML = details ? `<h2>${details.NombreCompleto || ''}</h2><p><strong>Grado:</strong> ${details.GradoAcademico || 'N/A'}<span>&nbsp;&nbsp;•&nbsp;&nbsp;</span><strong>Correo:</strong> ${details.CorreoElectronico || 'N/A'}</p>` : `<p class="message">No se encontraron detalles para este docente.</p>`; 
        }

        function isEntryTestTrulyComplete(reportInfo) {
            if (!reportInfo || !reportInfo.skills || reportInfo.skills.length === 0 || !reportInfo.evaluados || reportInfo.evaluados <= 0) {
                return false;
            }
            const totalEvaluados = parseInt(reportInfo.evaluados);
            for (const skill of reportInfo.skills) {
                const sumaFila = (parseInt(skill.deficiente_cantidad) || 0) + 
                                 (parseInt(skill.suficiente_cantidad) || 0) + 
                                 (parseInt(skill.bueno_cantidad) || 0);
                if (sumaFila !== totalEvaluados) {
                    return false;
                }
            }
            return true;
        }

        function isPortfolioTrulyComplete(reportInfo) {
            if (!reportInfo) return false;
            
            const matriculados = parseInt(reportInfo.matriculados) || 0;
            const retirados = parseInt(reportInfo.retirados) || 0;
            const abandono = parseInt(reportInfo.abandono) || 0;
            const aprobados = reportInfo.aprobados;
            const asisten = matriculados - retirados - abandono;
            const desaprobados = asisten - (parseInt(aprobados) || 0);
            if (matriculados <= 0 || asisten < 0 || desaprobados < 0 || aprobados === undefined || aprobados === null || aprobados === '') return false;

            const docenteObligatorios = ['silabo_upt', 'silabo_icacit', 'cv_icacit', 'material_curso', 'guias_lab', 'examenes', 'asistencia', 'notas'];
            for (const key of docenteObligatorios) {
                const hasCheck = reportInfo[`dig_${key}`] || reportInfo[`imp_${key}`];
                const hasCant = (parseInt(reportInfo[`cant_${key}`]) || 0) > 0;
                const hasUrl = !!reportInfo[`url_${key}`];
                if (!hasCheck || !hasCant || !hasUrl) return false;
            }

            const estudianteObligatorios = ['est_examenes', 'est_proyectos'];
            for (const key of estudianteObligatorios) {
                 const hasCheck = reportInfo[`dig_${key}`] || reportInfo[`imp_${key}`];
                 const hasCant = (parseInt(reportInfo[`cant_${key}`]) || 0) > 0;
                 const hasUrl = !!reportInfo[`url_${key}`];
                 if (!hasCheck || !hasCant || !hasUrl) return false;
            }
            
            return true;
        }

        function displayCourses(courses, teacherName) {
            coursesResultsDiv.innerHTML = '';
            if (!courses || courses.length === 0) { 
                coursesResultsDiv.innerHTML = `<p class="message">No se encontraron cursos para ${teacherName} en ${selectedSemester}.</p>`; 
                return; 
            }
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.dataset.course = JSON.stringify(course);
                
                let buttonsHtml = '';
                
                if (selectedReportType === 'entryTest') {
                    const reportId = `${selectedSemester}-${course.codigo}-${course.seccion}`;
                    const entryReportInfo = existingEntryReports[reportId];
                    if (entryReportInfo) {
                        card.dataset.entryReportInfo = JSON.stringify(entryReportInfo);
                        const isComplete = isEntryTestTrulyComplete(entryReportInfo);
                        if (isComplete) {
                            buttonsHtml += `<button class="btn btn-state-completed" data-report-type="entryTest">Informe Completado</button>`;
                        } else {
                            buttonsHtml += `<button class="btn btn-state-pending" data-report-type="entryTest">Informe Pendiente</button>`;
                        }
                        if(entryReportInfo.url) buttonsHtml += `<a href="${entryReportInfo.url}" target="_blank" class="btn">Ver PDF</a>`;
                    } else {
                        buttonsHtml += `<button class="btn btn-state-new" data-report-type="entryTest">Hacer Informe</button>`;
                    }
                } else if (selectedReportType.startsWith('portfolio_')) {
                    const unit = selectedReportType.split('_')[1];
                    const reportId = `${selectedSemester}-${course.codigo}-${course.seccion}-${unit}`;
                    const portfolioReportInfo = existingPortfolioReports[reportId];
                    if (portfolioReportInfo) {
                        card.dataset.portfolioReportInfo = JSON.stringify(portfolioReportInfo);
                        const isComplete = isPortfolioTrulyComplete(portfolioReportInfo);
                        if (isComplete) {
                             buttonsHtml += `<button class="btn btn-state-completed" data-report-type="${selectedReportType}">Portafolio Completado</button>`;
                        } else {
                             buttonsHtml += `<button class="btn btn-state-pending" data-report-type="${selectedReportType}">Portafolio Pendiente</button>`;
                        }
                        if (portfolioReportInfo.url) {
                            buttonsHtml += `<a href="${portfolioReportInfo.url}" target="_blank" class="btn">Ver Archivo</a>`;
                        }
                    } else {
                         buttonsHtml += `<button class="btn btn-state-new" data-report-type="${selectedReportType}">Hacer Portafolio (U${unit})</button>`;
                    }
                } else if (selectedReportType === 'docPortfolio') {
                    const reportId = `${selectedSemester}-${course.codigo}-${course.seccion}`;
                    const docPortfolioReportInfo = existingDocPortfolioReports[reportId];
                    if (docPortfolioReportInfo && docPortfolioReportInfo.URL_Informe) {
                        card.dataset.docPortfolioReportInfo = JSON.stringify(docPortfolioReportInfo);
                         buttonsHtml += `<button class="btn primary" data-report-type="docPortfolio">Editar Documentación</button><a href="${docPortfolioReportInfo.URL_Informe}" target="_blank" class="btn">Ver Archivo</a>`;
                    } else {
                        buttonsHtml += `<button class="btn btn-doc-portfolio-new" data-report-type="docPortfolio">Registrar Documentación</button>`;
                    }
                }

                card.innerHTML = `
                    <h3>${course.codigo} - ${course.nombre}</h3>
                    <p style="color: var(--text-secondary); margin-top: -8px; margin-bottom: 16px;"><strong>Sección:</strong> ${course.seccion}</p>
                    <div class="details-grid">
                        <div class="detail-item"><strong>Ciclo:</strong> ${course.ciclo}</div><div class="detail-item"><strong>Horas:</strong> ${course.horas}</div>
                        <div class="detail-item"><strong>Créditos:</strong> ${course.creditos}</div><div class="detail-item"><strong>Tipo:</strong> ${course.tipo}</div>
                        <div class="detail-item" style="grid-column: span 2;"><strong>Área:</strong> ${course.area}</div>
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <div class="card-buttons">${buttonsHtml}</div>`;
                coursesResultsDiv.appendChild(card);
            });
        }
        
        coursesResultsDiv.addEventListener('click', e => {
            const button = e.target.closest('button[data-report-type]');
            if (!button) return;
            
            const card = button.closest('.course-card');
            currentCourseData = JSON.parse(card.dataset.course);
            const reportType = button.dataset.reportType;

            if (reportType === 'entryTest') {
                const reportInfo = card.dataset.entryReportInfo ? JSON.parse(card.dataset.entryReportInfo) : null;
                openReportModal(reportInfo);
            } else if (reportType.startsWith('portfolio_')) {
                const unit = reportType.split('_')[1];
                const reportId = `${selectedSemester}-${currentCourseData.codigo}-${currentCourseData.seccion}-${unit}`;
                const reportInfo = existingPortfolioReports[reportId] || null;
                openPortfolioModal(reportInfo, unit);
            } else if (reportType === 'docPortfolio') {
                const reportId = `${selectedSemester}-${currentCourseData.codigo}-${currentCourseData.seccion}`;
                const reportInfo = existingDocPortfolioReports[reportId] || null;
                openDocPortfolioModal(reportInfo);
            }
        });

        function openReportModal(reportInfo) {
            const isEditing = !!reportInfo;
            currentReportId = isEditing ? `${selectedSemester}-${currentCourseData.codigo}-${currentCourseData.seccion}` : null;
            
            modalTitle.innerHTML = `Informe de Prueba de Entrada
                                  <small>${currentCourseData.codigo} - ${currentCourseData.nombre} (Sección ${currentCourseData.seccion})<br><b>Docente:</b> ${currentTeacherData.NombreCompleto}</small>`;
            
            reportModal.style.display = 'flex';
            
            setTimeout(() => {
                entrySignaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)' });
                resizeCanvas(signatureCanvas, entrySignaturePad);
            }, 100); 

            skillsContainer.innerHTML = '';
            finalResponseDiv.innerHTML = '';
            saveReportBtn.style.display = 'block';
            addSkillBtn.style.display = 'inline-flex';

            saveReportBtn.innerHTML = isEditing ? 'Actualizar Informe' : 'Guardar Informe';
            saveReportBtn.disabled = false;

            matriculadosInput.value = isEditing ? reportInfo.matriculados : '';
            evaluadosInput.value = isEditing ? reportInfo.evaluados : '';

            if (isEditing && reportInfo.skills && reportInfo.skills.length > 0 && reportInfo.skills[0].name) { 
                reportInfo.skills.forEach(skill => addSkillRow(skill)); 
            } else { 
                addSkillRow(); 
            }

            const corrective = isEditing ? reportInfo.correctiveMeasures : {};
            chkRepasoClase.checked = corrective.repaso_clase || false;
            chkRepasoAdicional.checked = corrective.repaso_adicional || false;
            chkEjerciciosCasa.checked = corrective.ejercicios_casa || false;
            chkEntregaMaterial.checked = corrective.entrega_material || false;
            chkRecomendacionBiblio.checked = corrective.recomendacion_biblio || false;
            chkOtros.checked = corrective.otros_check || false;
            txtOtrosDescripcion.value = corrective.otros_descripcion || '';
            inputFecha.value = corrective.fecha || new Date().toISOString().split('T')[0];

            if (isEditing && reportInfo.signatureImageUrl) {
                const previewUrl = reportInfo.signatureImageUrl.replace("/uc?id=", "/file/d/") + "/preview";
                existingSignatureIframe.src = previewUrl;
                existingSignatureWrapper.style.display = 'block';
                signaturePadWrapper.style.display = 'none';
                clearSignatureBtn.textContent = 'Firmar de Nuevo';
            } else {
                existingSignatureWrapper.style.display = 'none';
                signaturePadWrapper.style.display = 'block';
                clearSignatureBtn.textContent = 'Limpiar Firma';
            }

            recalculateAndValidate();
        }

        function openPortfolioModal(reportInfo, unit) {
            const isEditing = !!reportInfo;
            currentReportId = isEditing ? `${selectedSemester}-${currentCourseData.codigo}-${currentCourseData.seccion}-${unit}` : null;
            
            portfolioModalTitle.innerHTML = `Portafolio (Unidad ${unit})
                                           <small>${currentCourseData.nombre} (${currentCourseData.seccion})<br><b>Docente:</b> ${currentTeacherData.NombreCompleto}</small>`;
            
            portfolioModal.style.display = 'flex';
            
            setTimeout(() => {
                portfolioSignaturePad = new SignaturePad(signatureCanvasPortfolio, { backgroundColor: 'rgb(255, 255, 255)' });
                resizeCanvas(signatureCanvasPortfolio, portfolioSignaturePad);
            }, 100);

            p_matriculados.value = isEditing ? reportInfo.matriculados : '';
            p_retirados.value = isEditing ? reportInfo.retirados : '';
            p_abandono.value = isEditing ? reportInfo.abandono : '';
            p_aprobados.value = (isEditing && reportInfo.aprobados !== undefined) ? reportInfo.aprobados : '';
            inputFechaPortfolio.value = isEditing ? (reportInfo.fecha_entrega ? new Date(reportInfo.fecha_entrega).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0];
            
            materialKeys.forEach(key => {
                const digEl = document.getElementById(`dig_${key}`);
                const impEl = document.getElementById(`imp_${key}`);
                const cantEl = document.getElementById(`cant_${key}`);
                const fileInput = document.getElementById(`file_${key}`);
                const fileNameSpan = document.getElementById(`fname_${key}`);

                if(digEl) digEl.checked = isEditing && reportInfo[`dig_${key}`];
                if(impEl) impEl.checked = isEditing && reportInfo[`imp_${key}`];
                if(cantEl) cantEl.value = isEditing ? reportInfo[`cant_${key}`] || '' : '';
                
                if(fileInput) fileInput.value = '';
                if(fileNameSpan) {
                     if (isEditing && reportInfo[`url_${key}`]) {
                        fileNameSpan.innerHTML = `<a href="${reportInfo[`url_${key}`]}" target="_blank">Ver Evidencia</a>`;
                        fileNameSpan.classList.add('file-name-filled');
                    } else {
                        fileNameSpan.textContent = 'Ningún archivo.';
                        fileNameSpan.classList.remove('file-name-filled');
                    }
                }
            });
            
            if (isEditing && reportInfo.firma_url) {
                const previewUrl = reportInfo.firma_url.replace("/uc?id=", "/file/d/") + "/preview";
                existingSignatureIframePortfolio.src = previewUrl;
                existingSignatureWrapperPortfolio.style.display = 'block';
                signaturePadWrapperPortfolio.style.display = 'none';
                clearSignatureBtnPortfolio.textContent = 'Firmar de Nuevo';
            } else {
                existingSignatureWrapperPortfolio.style.display = 'none';
                signaturePadWrapperPortfolio.style.display = 'block';
                clearSignatureBtnPortfolio.textContent = 'Limpiar Firma';
            }

            finalResponsePortfolioDiv.innerHTML = '';
            savePortfolioBtn.style.display = 'block';
            savePortfolioBtn.innerHTML = isEditing ? 'Actualizar Datos' : 'Guardar Datos';
            savePortfolioBtn.disabled = false;
            
            calculatePortfolio();
            updatePortfolioStatusIndicator();
        }

        function openDocPortfolioModal(reportInfo) {
            const isEditing = !!reportInfo;
            currentReportId = isEditing ? `${selectedSemester}-${currentCourseData.codigo}-${currentCourseData.seccion}` : null;
            
            docPortfolioModalTitle.innerHTML = `Documentación del Portafolio
                                              <small>${currentCourseData.nombre} (${currentCourseData.seccion})<br><b>Docente:</b> ${currentTeacherData.NombreCompleto}</small>`;
            
            docPortfolioModal.style.display = 'flex';
            
            setTimeout(() => {
                docPortfolioSignaturePad = new SignaturePad(signatureCanvasDoc, { backgroundColor: 'rgb(255, 255, 255)' });
                resizeCanvas(signatureCanvasDoc, docPortfolioSignaturePad);
            }, 100);

            buildDocPortfolioForm(reportInfo);

            if (isEditing && reportInfo.Firma_URL) {
                const previewUrl = reportInfo.Firma_URL.replace("/uc?id=", "/file/d/") + "/preview";
                existingSignatureIframeDoc.src = previewUrl;
                existingSignatureWrapperDoc.style.display = 'block';
                signaturePadWrapperDoc.style.display = 'none';
                clearSignatureBtnDoc.textContent = 'Firmar de Nuevo';
            } else {
                existingSignatureWrapperDoc.style.display = 'none';
                signaturePadWrapperDoc.style.display = 'block';
                clearSignatureBtnDoc.textContent = 'Limpiar Firma';
            }

            finalResponseDocPortfolioDiv.innerHTML = '';
            saveDocPortfolioBtn.style.display = 'block';
            saveDocPortfolioBtn.innerHTML = isEditing ? 'Actualizar Documentación' : 'Guardar Documentación';
            saveDocPortfolioBtn.disabled = false;
        }

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-overlay');
                modal.style.display = 'none';
                if (refreshOnClose && teacherInput.value) {
                    performSearch(teacherInput.value);
                }
                refreshOnClose = false;
            });
        });

        addSkillBtn.addEventListener('click', () => { if (skillsContainer.children.length < 5) addSkillRow(); });
        skillsContainer.addEventListener('click', e => { if (e.target.classList.contains('btn-remove-skill')) { if (skillsContainer.children.length > 1) e.target.parentElement.remove(); recalculateAndValidate(); } });
        
        function addSkillRow(skill = null) {
            const skillRow = document.createElement('div');
            skillRow.className = 'skill-row';
            skillRow.innerHTML = `<input type="text" placeholder="Escribe aquí..." value="${skill && skill.name ? skill.name : ''}"><input type="number" class="level-input" min="0" data-level="deficiente" value="${skill && skill.deficiente_cantidad ? skill.deficiente_cantidad : ''}"><span class="percent" data-level="deficiente-p">0.0</span><input type="number" class="level-input" min="0" data-level="suficiente" value="${skill && skill.suficiente_cantidad ? skill.suficiente_cantidad : ''}"><span class="percent" data-level="suficiente-p">0.0</span><input type="number" class="level-input" min="0" data-level="bueno" value="${skill && skill.bueno_cantidad ? skill.bueno_cantidad : ''}"><span class="percent" data-level="bueno-p">0.0</span><span class="percent" data-level="total-p">0.0%</span><button class="btn btn-remove-skill">×</button>`;
            skillsContainer.appendChild(skillRow);
        }
        
        reportModal.addEventListener('input', recalculateAndValidate);
        
        function updateStatusIndicator(indicatorEl, isComplete) {
             indicatorEl.textContent = isComplete ? 'Estado: Completado' : 'Estado: Pendiente';
             indicatorEl.className = 'status-indicator';
             indicatorEl.classList.add(isComplete ? 'pct-bg-green' : 'pct-bg-yellow');
        }

        function recalculateAndValidate() {
            let isOverallValid = true;
            let isReportComplete = true; 
            const matriculados = parseInt(matriculadosInput.value) || 0;
            const evaluados = parseInt(evaluadosInput.value) || 0;
            
            if (skillsContainer.children.length === 0 && evaluados > 0) isReportComplete = false;

            validationMsg.textContent = '';
            if (evaluados > matriculados && matriculados > 0) { isOverallValid = false; evaluadosInput.classList.add('input-error'); validationMsg.textContent = 'Error: Evaluados no puede superar a Matriculados.'; } 
            else { evaluadosInput.classList.remove('input-error'); }
            
            document.querySelectorAll('.skill-row').forEach(row => {
                const inputs = row.querySelectorAll('.level-input'); let sumaFila = 0; inputs.forEach(input => sumaFila += parseInt(input.value) || 0);
                const rowIsValid = (evaluados === 0) || (sumaFila <= evaluados);
                if (!rowIsValid) isOverallValid = false;
                inputs.forEach(input => input.classList.toggle('input-error', !rowIsValid));
                
                if (sumaFila !== evaluados || evaluados === 0) {
                    isReportComplete = false;
                }

                const def = parseInt(row.querySelector('[data-level="deficiente"]').value) || 0, suf = parseInt(row.querySelector('[data-level="suficiente"]').value) || 0, bue = parseInt(row.querySelector('[data-level="bueno"]').value) || 0;
                const pDef = evaluados > 0 ? (def / evaluados) * 100 : 0, pSuf = evaluados > 0 ? (suf / evaluados) * 100 : 0, pBue = evaluados > 0 ? (bue / evaluados) * 100 : 0;
                const pTotal = pDef + pSuf + pBue;
                
                row.querySelector('[data-level="deficiente-p"]').textContent = pDef.toFixed(1); 
                row.querySelector('[data-level="suficiente-p"]').textContent = pSuf.toFixed(1); 
                row.querySelector('[data-level="bueno-p"]').textContent = pBue.toFixed(1);
                row.querySelector('[data-level="total-p"]').textContent = pTotal.toFixed(1) + '%';

                const totalPercentSpan = row.querySelector('[data-level="total-p"]');
                totalPercentSpan.classList.remove('pct-bg-green', 'pct-bg-yellow', 'pct-bg-red');
                if (pTotal > 100.1) totalPercentSpan.classList.add('pct-bg-red');
                else if (pTotal > 99.9 && pTotal < 100.1) totalPercentSpan.classList.add('pct-bg-green');
                else if (pTotal >= 60) totalPercentSpan.classList.add('pct-bg-yellow');
            });

            updateStatusIndicator(entryTestStatusIndicator, isReportComplete);

            if (validationMsg.textContent === '') { validationMsg.textContent = isOverallValid ? '' : 'Error: La suma por fila no puede superar el total de evaluados.'; }
            const hasSkillName = skillsContainer.querySelector('input[type="text"]')?.value.trim() !== '';
            saveReportBtn.disabled = !isOverallValid || evaluados === 0 || matriculados === 0 || !hasSkillName;
        }
        
        portfolioFormContainer.addEventListener('input', () => {
            calculatePortfolio();
            updatePortfolioStatusIndicator();
        });

        function updatePortfolioStatusIndicator() {
             const isComplete = checkPortfolioCompletenessFromForm();
             updateStatusIndicator(portfolioStatusIndicator, isComplete);
        }

        function checkPortfolioCompletenessFromForm() {
            const matriculados = parseInt(p_matriculados.value) || 0;
            const retirados = parseInt(p_retirados.value) || 0;
            const abandono = parseInt(p_abandono.value) || 0;
            const aprobados = document.getElementById('p_aprobados').value;
            const asisten = matriculados - retirados - abandono;
            const desaprobados = asisten - (parseInt(aprobados) || 0);
            if (matriculados <= 0 || asisten < 0 || desaprobados < 0 || aprobados === '') return false;

            const docenteObligatorios = ['silabo_upt', 'silabo_icacit', 'cv_icacit', 'material_curso', 'guias_lab', 'examenes', 'asistencia', 'notas'];
            for (const key of docenteObligatorios) {
                const hasCheck = document.getElementById(`dig_${key}`).checked || document.getElementById(`imp_${key}`).checked;
                const hasCant = (parseInt(document.getElementById(`cant_${key}`).value) || 0) > 0;
                const hasFile = document.getElementById(`file_${key}`).files.length > 0 || document.getElementById(`fname_${key}`).querySelector('a');
                if (!hasCheck || !hasCant || !hasFile) return false;
            }

            const estudianteObligatorios = ['est_examenes', 'est_proyectos'];
            for (const key of estudianteObligatorios) {
                const hasCheck = document.getElementById(`dig_${key}`).checked || document.getElementById(`imp_${key}`).checked;
                const hasCant = (parseInt(document.getElementById(`cant_${key}`).value) || 0) > 0;
                const hasFile = document.getElementById(`file_${key}`).files.length > 0 || document.getElementById(`fname_${key}`).querySelector('a');
                if (!hasCheck || !hasCant || !hasFile) return false;
            }
            
            return true;
        }

        function calculatePortfolio() {
            let isValid = true;
            let validationMessage = '';
            const matriculados = parseInt(p_matriculados.value) || 0;
            const retirados = parseInt(p_retirados.value) || 0;
            const abandono = parseInt(p_abandono.value) || 0;
            const aprobados = parseInt(p_aprobados.value) || 0;
            const asisten = matriculados - retirados - abandono;
            p_asisten.value = asisten >= 0 ? asisten : 0;
            const desaprobados = asisten - aprobados;
            p_desaprobados.value = desaprobados >= 0 ? desaprobados : 0;
            
            if (matriculados <= 0 && p_matriculados.value !== '') {
                validationMessage = 'Debe ingresar un número válido de matriculados.'; isValid = false;
            } else if (asisten < 0) {
                validationMessage = 'Error: Retirados y abandonos superan a los matriculados.'; isValid = false;
            } else if (desaprobados < 0) {
                validationMessage = 'Error: Aprobados superan a los que asisten.'; isValid = false;
            }

            portfolioValidationMsg.textContent = validationMessage;
            
            savePortfolioBtn.disabled = !isValid || (p_matriculados.value === '');
            
            const formatPctText = (val, total) => total > 0 ? ((val / total) * 100).toFixed(1) + '%' : '0.0%';

            document.getElementById('p_matriculados_span').textContent = formatPctText(matriculados, matriculados);
            document.getElementById('p_retirados_span').textContent = formatPctText(retirados, matriculados);
            document.getElementById('p_abandono_span').textContent = formatPctText(abandono, matriculados);
            document.getElementById('p_asisten_span').textContent = formatPctText(asisten, matriculados);
            document.getElementById('p_aprobados_span').textContent = formatPctText(aprobados, matriculados);
            document.getElementById('p_desaprobados_span').textContent = formatPctText(desaprobados, matriculados);
            
            const asisten_pct_val = matriculados > 0 ? (asisten / matriculados) * 100 : 0;
            const asistenBarContainer = p_asisten.nextElementSibling;
            asistenBarContainer.classList.remove('pct-bg-green', 'pct-bg-yellow', 'pct-bg-red');
            
            if (asisten_pct_val >= 90) asistenBarContainer.classList.add('pct-bg-green');
            else if (asisten_pct_val >= 60) asistenBarContainer.classList.add('pct-bg-yellow');
            else asistenBarContainer.classList.add('pct-bg-red');
        }
        
        saveReportBtn.addEventListener('click', async () => {
            saveReportBtn.disabled = true; saveReportBtn.innerHTML = `<div class="spinner" style="width:20px; height:20px; border-width:3px; margin:auto;"></div>`; finalResponseDiv.innerHTML = '';
            const reportData = {
                uniqueId: currentReportId, semestre: selectedSemester, matriculados: matriculadosInput.value, evaluados: evaluadosInput.value,
                course: currentCourseData, docente: currentTeacherData,
                skills: Array.from(skillsContainer.querySelectorAll('.skill-row')).map(row => {
                    const totalEvaluados = parseInt(evaluadosInput.value) || 0;
                    const def = parseInt(row.querySelector('[data-level="deficiente"]').value) || 0, suf = parseInt(row.querySelector('[data-level="suficiente"]').value) || 0, bue = parseInt(row.querySelector('[data-level="bueno"]').value) || 0;
                    return {
                        name: row.querySelector('input[type="text"]').value,
                        deficiente_cantidad: def, deficiente_porcentaje: totalEvaluados > 0 ? (def / totalEvaluados) : 0,
                        suficiente_cantidad: suf, suficiente_porcentaje: totalEvaluados > 0 ? (suf / totalEvaluados) : 0,
                        bueno_cantidad: bue, bueno_porcentaje: totalEvaluados > 0 ? (bue / totalEvaluados) : 0,
                        total_porcentaje: totalEvaluados > 0 ? ((def + suf + bue) / totalEvaluados) : 0
                    };
                }).filter(skill => skill.name.trim() !== ''),
                correctiveMeasures: {
                    repaso_clase: chkRepasoClase.checked, repaso_adicional: chkRepasoAdicional.checked, ejercicios_casa: chkEjerciciosCasa.checked,
                    entrega_material: chkEntregaMaterial.checked, recomendacion_biblio: chkRecomendacionBiblio.checked, otros_check: chkOtros.checked,
                    otros_descripcion: txtOtrosDescripcion.value, fecha: inputFecha.value
                },
                signatureBase64: (signaturePadWrapper.style.display !== 'none' && entrySignaturePad && !entrySignaturePad.isEmpty()) ? entrySignaturePad.toDataURL('image/png') : null,
                existingSignatureUrl: (currentReportId && existingEntryReports[currentReportId]) ? existingEntryReports[currentReportId].signatureImageUrl : null
            };
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'saveReport', reportType: 'entryTest', data: reportData }) });
                const result = await response.json();
                if (result.success) {
                    refreshOnClose = true; saveReportBtn.style.display = 'none'; addSkillBtn.style.display = 'none';
                    finalResponseDiv.innerHTML = `✅ ¡Informe Guardado! <a href="${result.url}" target="_blank">Abrir Archivo</a>`;
                } else { throw new Error(result.message || 'Error desconocido.'); }
            } catch (error) {
                finalResponseDiv.innerHTML = `<span style="color:var(--danger-color)">Error: ${error.message}</span>`;
                saveReportBtn.innerHTML = 'Guardar Informe'; saveReportBtn.disabled = false;
            }
        });
    
        savePortfolioBtn.addEventListener('click', async () => {
            savePortfolioBtn.disabled = true;
            savePortfolioBtn.innerHTML = `<div class="spinner" style="width:20px; height:20px; border-width:3px; margin:auto;"></div>`;
            finalResponsePortfolioDiv.innerHTML = 'Procesando archivos...';

            const reportInfo = existingPortfolioReports[currentReportId];
            const portfolioData = {
                uniqueId: currentReportId, semestre: selectedSemester, course: currentCourseData, docente: currentTeacherData,
                matriculados: p_matriculados.value, retirados: p_retirados.value, abandono: p_abandono.value,
                asisten: p_asisten.value, aprobados: p_aprobados.value, desaprobados: p_desaprobados.value,
                matriculados_pct: (parseFloat(document.getElementById('p_matriculados_span').textContent) || 0) / 100,
                retirados_pct: (parseFloat(document.getElementById('p_retirados_span').textContent) || 0) / 100,
                abandono_pct: (parseFloat(document.getElementById('p_abandono_span').textContent) || 0) / 100,
                asisten_pct: (parseFloat(document.getElementById('p_asisten_span').textContent) || 0) / 100,
                aprobados_pct: (parseFloat(document.getElementById('p_aprobados_span').textContent) || 0) / 100,
                desaprobados_pct: (parseFloat(document.getElementById('p_desaprobados_span').textContent) || 0) / 100,
                fecha_entrega: inputFechaPortfolio.value,
                signatureBase64: (signaturePadWrapperPortfolio.style.display !== 'none' && portfolioSignaturePad && !portfolioSignaturePad.isEmpty()) ? portfolioSignaturePad.toDataURL('image/png') : null,
                existingSignatureUrl: (reportInfo) ? reportInfo.firma_url : null,
                files: {}
            };

            materialKeys.forEach(key => {
                portfolioData[`dig_${key}`] = document.getElementById(`dig_${key}`).checked;
                portfolioData[`imp_${key}`] = document.getElementById(`imp_${key}`).checked;
                portfolioData[`cant_${key}`] = document.getElementById(`cant_${key}`).value;
                if(reportInfo) { portfolioData[`url_${key}`] = reportInfo[`url_${key}`] || ''; }
            });
            
            const readFileAsBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve({ base64: base64String, name: file.name, type: file.type });
                    };
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            };

            const filePromises = [];
            materialKeys.forEach(key => {
                const fileInput = document.getElementById(`file_${key}`);
                if (fileInput.files[0]) {
                    if (fileInput.files[0].size > 15 * 1024 * 1024) {
                         Swal.fire('Archivo muy grande', `El archivo para "${key}" supera los 15MB.`, 'error');
                         savePortfolioBtn.innerHTML = 'Guardar Datos'; savePortfolioBtn.disabled = false;
                         throw new Error("File size exceeded");
                    }
                    filePromises.push(readFileAsBase64(fileInput.files[0]).then(fileData => { portfolioData.files[key] = fileData; }));
                }
            });

            await Promise.all(filePromises);
            finalResponsePortfolioDiv.innerHTML = 'Enviando datos...';
            
            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', mode: 'cors', cache: 'no-cache', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({ action: 'saveReport', reportType: selectedReportType, data: portfolioData }) 
                });
                const result = await response.json();
                if (result.success) {
                    refreshOnClose = true; savePortfolioBtn.style.display = 'none';
                    finalResponsePortfolioDiv.innerHTML = `✅ ¡Datos Guardados! <a href="${result.url}" target="_blank">Abrir Archivo</a>`;
                } else { throw new Error(result.message || 'Error desconocido.'); }
            } catch (error) {
                finalResponsePortfolioDiv.innerHTML = `<span style="color:var(--danger-color)">Error: ${error.message}</span>`;
                savePortfolioBtn.innerHTML = 'Guardar Datos'; savePortfolioBtn.disabled = false;
            }
        });
        
        portfolioFormContainer.addEventListener('change', e => {
            if(e.target.type === 'file') {
                const key = e.target.id.replace('file_', '');
                const fileNameSpan = document.getElementById(`fname_${key}`);
                if (e.target.files[0]) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    fileNameSpan.classList.add('file-name-filled');
                } else {
                    const reportInfo = existingPortfolioReports[currentReportId];
                    const originalUrl = (reportInfo && reportInfo[`url_${key}`]) ? `<a href="${reportInfo[`url_${key}`]}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';
                    fileNameSpan.innerHTML = originalUrl;
                     if (!reportInfo || !reportInfo[`url_${key}`]) {
                        fileNameSpan.classList.remove('file-name-filled');
                    }
                }
            }
        });

        function buildDocPortfolioForm(reportInfo) {
            docPortfolioFormContainer.innerHTML = '';
            let projectCount = 0;

            const createItem = (item) => {
                const urlValue = (reportInfo && reportInfo[item.key]) ? reportInfo[item.key] : '';
                const hasUrl = !!urlValue;
                const urlText = hasUrl ? `<a href="${urlValue}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';
                const filledClass = hasUrl ? 'file-name-filled' : '';
                return `
                    <div class="doc-item">
                        <label for="file_doc_${item.key}">${item.label}</label>
                        <div class="file-upload-wrapper">
                            <label for="file_doc_${item.key}" class="btn file-btn">Adjuntar</label>
                            <input type="file" id="file_doc_${item.key}">
                            <span class="file-name ${filledClass}" id="fname_doc_${item.key}">${urlText}</span>
                        </div>
                    </div>`;
            };

            docPortfolioStructure.forEach(el => {
                if (el.type === 'category') {
                    docPortfolioFormContainer.innerHTML += `<div class="doc-category">${el.label}</div>`;
                } else if (el.type === 'subcategory') {
                    docPortfolioFormContainer.innerHTML += `<div class="doc-subcategory">${el.label}</div>`;
                } else if (el.type === 'item') {
                    docPortfolioFormContainer.innerHTML += createItem(el);
                } else if (el.type === 'project_section') {
                    docPortfolioFormContainer.innerHTML += `<div class="doc-subcategory">${el.label}</div><div id="projects-container"></div>`;
                }
            });

            docPortfolioFormContainer.innerHTML += `<div style="text-align: right; margin-top: 20px;"><button type="button" id="addProjectBtn" class="btn primary">+ Agregar Otro Proyecto</button></div>`;
            const projectsContainer = docPortfolioFormContainer.querySelector('#projects-container');

            const addProjectBlock = (projectData = {}) => {
                projectCount++;
                const block = document.createElement('div');
                block.className = 'project-block';
                block.dataset.index = projectCount;

                const hasDoc = !!projectData.docUrl;
                const hasSoft = !!projectData.softUrl;
                const hasAnexos = !!projectData.anexosUrl;
                const hasVideo = !!projectData.videoUrl;

                const docText = hasDoc ? `<a href="${projectData.docUrl}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';
                const softText = hasSoft ? `<a href="${projectData.softUrl}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';
                const anexosText = hasAnexos ? `<a href="${projectData.anexosUrl}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';
                const videoText = hasVideo ? `<a href="${projectData.videoUrl}" target="_blank">Ver Evidencia</a>` : 'Ningún archivo.';

                block.innerHTML = `
                    <div class="project-header">
                        <span>--- Proyecto ${projectCount} ---</span>
                        ${projectCount > 1 ? '<button type="button" class="btn btn-remove-skill">×</button>' : ''}
                    </div>
                    <div class="project-item">
                        <label for="p_nombre_${projectCount}">Proyecto (U3)</label>
                        <input type="text" id="p_nombre_${projectCount}" value="${projectData.nombre || ''}">
                    </div>
                    <div class="project-item">
                        <label for="file_doc_p_doc_${projectCount}">Documentación (U3)</label>
                        <div class="file-upload-wrapper">
                            <label for="file_doc_p_doc_${projectCount}" class="btn file-btn">Adjuntar</label>
                            <input type="file" id="file_doc_p_doc_${projectCount}">
                            <span class="file-name ${hasDoc ? 'file-name-filled' : ''}" id="fname_doc_p_doc_${projectCount}">${docText}</span>
                        </div>
                    </div>
                    <div class="project-item">
                        <label for="file_doc_p_soft_${projectCount}">Software (U3)</label>
                        <div class="file-upload-wrapper">
                            <label for="file_doc_p_soft_${projectCount}" class="btn file-btn">Adjuntar</label>
                            <input type="file" id="file_doc_p_soft_${projectCount}">
                            <span class="file-name ${hasSoft ? 'file-name-filled' : ''}" id="fname_doc_p_soft_${projectCount}">${softText}</span>
                        </div>
                    </div>
                    <div class="project-item">
                        <label for="file_doc_p_anexos_${projectCount}">Anexos (U3)</label>
                        <div class="file-upload-wrapper">
                            <label for="file_doc_p_anexos_${projectCount}" class="btn file-btn">Adjuntar</label>
                            <input type="file" id="file_doc_p_anexos_${projectCount}">
                            <span class="file-name ${hasAnexos ? 'file-name-filled' : ''}" id="fname_doc_p_anexos_${projectCount}">${anexosText}</span>
                        </div>
                    </div>
                    <div class="project-item">
                        <label for="file_doc_p_video_${projectCount}">Video (U3)</label>
                        <div class="file-upload-wrapper">
                            <label for="file_doc_p_video_${projectCount}" class="btn file-btn">Adjuntar</label>
                            <input type="file" id="file_doc_p_video_${projectCount}">
                            <span class="file-name ${hasVideo ? 'file-name-filled' : ''}" id="fname_doc_p_video_${projectCount}">${videoText}</span>
                        </div>
                    </div>
                `;
                projectsContainer.appendChild(block);
            };

            if (reportInfo && reportInfo.nombres_proyectos_u3 && reportInfo.nombres_proyectos_u3.length > 0 && reportInfo.nombres_proyectos_u3[0]) {
                reportInfo.nombres_proyectos_u3.forEach((name, i) => {
                    addProjectBlock({
                        nombre: name,
                        docUrl: reportInfo.urls_documentacion_proyectos_u3[i],
                        softUrl: reportInfo.urls_software_proyectos_u3[i],
                        anexosUrl: reportInfo.urls_anexos_proyectos_u3[i],
                        videoUrl: reportInfo.urls_video_proyectos_u3[i]
                    });
                });
            } else {
                addProjectBlock();
            }

            docPortfolioFormContainer.addEventListener('click', e => {
                if (e.target.id === 'addProjectBtn') {
                    addProjectBlock();
                }
                if (e.target.classList.contains('btn-remove-skill')) {
                    e.target.closest('.project-block').remove();
                }
            });
        }

        docPortfolioFormContainer.addEventListener('change', e => {
            if (e.target.type === 'file') {
                const id = e.target.id;
                const fileNameSpan = docPortfolioFormContainer.querySelector(`#fname_${id.substring(5)}`);
                if (fileNameSpan) {
                    if (e.target.files[0]) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        fileNameSpan.classList.add('file-name-filled');
                    } else {
                        fileNameSpan.textContent = 'Ningún archivo.';
                        fileNameSpan.classList.remove('file-name-filled');
                    }
                }
            }
        });

        saveDocPortfolioBtn.addEventListener('click', async () => {
            saveDocPortfolioBtn.disabled = true;
            saveDocPortfolioBtn.innerHTML = `<div class="spinner" style="width:20px; height:20px; border-width:3px; margin:auto;"></div>`;
            finalResponseDocPortfolioDiv.innerHTML = 'Procesando archivos...';

            const reportInfo = existingDocPortfolioReports[currentReportId];
            const docPortfolioData = {
                uniqueId: currentReportId,
                semestre: selectedSemester,
                course: currentCourseData,
                docente: currentTeacherData,
                signatureBase64: (signaturePadWrapperDoc.style.display !== 'none' && docPortfolioSignaturePad && !docPortfolioSignaturePad.isEmpty()) ? docPortfolioSignaturePad.toDataURL('image/png') : null,
                existingSignatureUrl: (reportInfo) ? reportInfo.Firma_URL : null,
                files: {},
                projects: []
            };

            const staticKeys = docPortfolioStructure.filter(el => el.type === 'item').map(el => el.key);
            staticKeys.forEach(key => {
                if(reportInfo) docPortfolioData[key] = reportInfo[key] || '';
            });
            
            const readFileAsBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve({ base64: base64String, name: file.name, type: file.type });
                    };
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            };

            const filePromises = [];
            staticKeys.forEach(key => {
                const fileInput = document.getElementById(`file_doc_${key}`);
                if (fileInput && fileInput.files[0]) {
                     if (fileInput.files[0].size > 15 * 1024 * 1024) {
                         Swal.fire('Archivo muy grande', `El archivo para "${key}" supera los 15MB.`, 'error');
                         saveDocPortfolioBtn.innerHTML = 'Guardar Documentación'; saveDocPortfolioBtn.disabled = false;
                         throw new Error("File size exceeded");
                    }
                    filePromises.push(readFileAsBase64(fileInput.files[0]).then(fileData => {
                        docPortfolioData.files[key] = fileData;
                    }));
                }
            });

            document.querySelectorAll('.project-block').forEach((block, i) => {
                const index = block.dataset.index;
                const project = {
                    nombre: document.getElementById(`p_nombre_${index}`).value,
                    files: {},
                    urls: {}
                };
                
                if(reportInfo && reportInfo.urls_documentacion_proyectos_u3) project.urls.documentacion = reportInfo.urls_documentacion_proyectos_u3[i] || '';
                if(reportInfo && reportInfo.urls_software_proyectos_u3) project.urls.software = reportInfo.urls_software_proyectos_u3[i] || '';
                if(reportInfo && reportInfo.urls_anexos_proyectos_u3) project.urls.anexos = reportInfo.urls_anexos_proyectos_u3[i] || '';
                if(reportInfo && reportInfo.urls_video_proyectos_u3) project.urls.video = reportInfo.urls_video_proyectos_u3[i] || '';

                const docFile = document.getElementById(`file_doc_p_doc_${index}`).files[0];
                const softFile = document.getElementById(`file_doc_p_soft_${index}`).files[0];
                const anexosFile = document.getElementById(`file_doc_p_anexos_${index}`).files[0];
                const videoFile = document.getElementById(`file_doc_p_video_${index}`).files[0];

                if(docFile) filePromises.push(readFileAsBase64(docFile).then(data => project.files.documentacion = data));
                if(softFile) filePromises.push(readFileAsBase64(softFile).then(data => project.files.software = data));
                if(anexosFile) filePromises.push(readFileAsBase64(anexosFile).then(data => project.files.anexos = data));
                if(videoFile) filePromises.push(readFileAsBase64(videoFile).then(data => project.files.video = data));
                
                docPortfolioData.projects.push(project);
            });

            await Promise.all(filePromises);
            finalResponseDocPortfolioDiv.innerHTML = 'Enviando datos...';
            
            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', mode: 'cors', cache: 'no-cache', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({ action: 'saveReport', reportType: 'docPortfolio', data: docPortfolioData }) 
                });
                const result = await response.json();
                if (result.success) {
                    refreshOnClose = true;
                    saveDocPortfolioBtn.style.display = 'none';
                    finalResponseDocPortfolioDiv.innerHTML = `✅ ¡Documentación Guardada! <a href="${result.url}" target="_blank">Abrir Archivo</a>`;
                } else { 
                    throw new Error(result.message || 'Error desconocido.'); 
                }
            } catch (error) {
                finalResponseDocPortfolioDiv.innerHTML = `<span style="color:var(--danger-color)">Error: ${error.message}</span>`;
                saveDocPortfolioBtn.innerHTML = 'Guardar Documentación';
                saveDocPortfolioBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
